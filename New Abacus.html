<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Абакус MindWorld School</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Baloo+2:wght@500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      color-scheme: light;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', 'Baloo 2', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #fdf8f3 0%, #fde68a 100%);
      color: #4b3b22;
      min-height: 100vh;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    header {
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: clamp(2rem, 3vw + 1rem, 2.75rem);
      font-weight: 700;
      color: #b36b0e;
    }

    p.lead {
      margin: 0.75rem 0 0;
      font-size: 1.05rem;
      color: #6b5c33;
    }

    .panel {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 18px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 20px 45px rgba(172, 129, 75, 0.18);
      backdrop-filter: blur(8px);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 1rem 1.5rem;
    }

    .controls label {
      font-weight: 600;
      font-size: 1rem;
      color: #6b5c33;
    }

    .count-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #b36b0e;
      min-width: 2.5rem;
      text-align: center;
    }

    input[type='range'] {
      width: min(360px, 70vw);
      accent-color: #d97706;
    }

    input[type='number'] {
      width: 5rem;
      padding: 0.45rem 0.6rem;
      border-radius: 10px;
      border: 1px solid rgba(179, 107, 14, 0.35);
      font-size: 1rem;
      font-family: inherit;
      color: #5c4a2a;
      background: rgba(255, 255, 255, 0.9);
    }

    button.reset-btn {
      border: none;
      padding: 0.6rem 1.4rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 1rem;
      font-family: inherit;
      color: #fff7ed;
      background: linear-gradient(135deg, #f97316, #ea580c);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 12px 24px rgba(234, 88, 12, 0.3);
    }

    button.reset-btn:hover,
    button.reset-btn:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(234, 88, 12, 0.35);
      outline: none;
    }

    button.reset-btn:active {
      transform: translateY(0);
    }

    .value-display {
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .value-display .caption {
      font-size: 0.95rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #856d3d;
    }

    .value-display .total {
      font-size: clamp(2rem, 4vw + 1rem, 3.2rem);
      font-weight: 700;
      color: #d97706;
    }

    .decimal-hint {
      font-size: 0.85rem;
      color: #8c7a4e;
    }

    .abacus-scroll {
      overflow-x: auto;
      padding: 1.75rem;
      border-radius: 22px;
      background: rgba(255, 255, 255, 0.6);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4), 0 22px 48px rgba(176, 128, 72, 0.22);
      -webkit-overflow-scrolling: touch;
    }

    .abacus-scroll::-webkit-scrollbar {
      height: 10px;
    }

    .abacus-scroll::-webkit-scrollbar-thumb {
      background: rgba(217, 119, 6, 0.65);
      border-radius: 999px;
    }

    .abacus-scroll::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.4);
      border-radius: 999px;
    }

    .abacus-svg {
      max-width: none;
      display: block;
      margin: 0 auto;
      touch-action: none;
    }

    .guide {
      font-size: 0.95rem;
      line-height: 1.6;
      color: #6b5c33;
      display: grid;
      gap: 0.5rem;
    }

    .guide strong {
      color: #b36b0e;
    }

    @media (max-width: 640px) {
      main {
        padding: 2rem 1rem 2.5rem;
      }

      .panel {
        padding: 1rem 1.25rem;
      }

      .controls {
        gap: 0.75rem 1rem;
      }

      input[type='number'] {
        width: 4.5rem;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Абакус MindWorld School</h1>
      <p class="lead">Интерактивный соробан с поддержкой до 23 разрядов и точками на средней планке</p>
    </header>

    <section class="panel">
      <div class="controls">
        <label for="digitRange">Количество разрядов:</label>
        <input id="digitRange" type="range" min="2" max="23" value="10" />
        <span class="count-value" id="digitCountValue">10</span>
        <button class="reset-btn" id="resetButton" type="button">Сброс</button>
      </div>
    </section>

    <section class="panel">
      <div class="controls">
        <label for="decimalOffsetInput" id="decimalLabel">Смещение запятой:</label>
        <input id="decimalOffsetInput" type="number" min="0" value="0" />
        <span class="decimal-hint" id="decimalHint">0 = после крайнего правого столбца</span>
      </div>
    </section>

    <section class="panel value-display">
      <span class="caption">Текущее значение</span>
      <span class="total" id="totalValue">0</span>
    </section>

    <section class="abacus-scroll panel" id="abacusScroll">
      <div id="abacusContainer"></div>
    </section>

    <section class="panel guide">
      <div><strong>Верхняя бусина</strong> (небесная) = 5, перемещайте к разделительной планке, чтобы активировать.</div>
      <div><strong>Нижние бусины</strong> (земные) = 1 каждая. Активные располагаются возле средней планки.</div>
      <div>Используйте ползунок, чтобы настроить количество разрядов, и поле «Смещение запятой», чтобы изменять расположение точек.</div>
      <div>Поддерживаются управление мышью и касаниями на мобильных устройствах.</div>
    </section>
  </main>

  <script type="module">
    import { Abacus } from './AbacusNew.js';

    const digitRange = document.getElementById('digitRange');
    const digitCountValue = document.getElementById('digitCountValue');
    const resetButton = document.getElementById('resetButton');
    const decimalInput = document.getElementById('decimalOffsetInput');
    const decimalHint = document.getElementById('decimalHint');
    const decimalLabel = document.getElementById('decimalLabel');
    const totalValue = document.getElementById('totalValue');
    const abacusContainer = document.getElementById('abacusContainer');

    const initialDigits = Number(digitRange.value) || 10;
    const initialDecimal = Number(decimalInput.value) || 0;

    const abacus = new Abacus(abacusContainer, {
      digitCount: initialDigits,
      decimalOffset: initialDecimal,
    });

    const syncDecimalInput = () => {
      const max = Math.max(0, abacus.digitCount - 1);
      decimalInput.max = String(max);

      const normalizedOffset = Math.min(Math.max(0, abacus.decimalOffset), max);
      decimalInput.value = String(normalizedOffset);
      decimalLabel.textContent = `Смещение запятой (0–${max})`;
      decimalHint.textContent = `${normalizedOffset} = ${normalizedOffset === 0 ? 'после крайнего правого столбца' : 'после ' + normalizedOffset + '-го столбца справа'}`;

      digitRange.value = String(abacus.digitCount);
      digitCountValue.textContent = abacus.digitCount;
    };

    const updateTotals = (total) => {
      totalValue.textContent = total.toLocaleString('ru-RU');
    };

    abacus.setOnChange((total) => {
      updateTotals(total);
      syncDecimalInput();
    });

    digitRange.addEventListener('input', () => {
      const count = Number(digitRange.value) || 2;
      digitCountValue.textContent = count;
      abacus.setDigitCount(count);
      const desiredOffset = Math.min(Math.max(0, Math.round(Number(decimalInput.value) || 0)), Math.max(0, count - 1));
      abacus.setDecimalOffset(desiredOffset);
      syncDecimalInput();
    });

    decimalInput.addEventListener('input', () => {
      const offset = Math.min(Math.max(0, Math.round(Number(decimalInput.value) || 0)), Number(decimalInput.max));
      decimalInput.value = String(offset);
      abacus.setDecimalOffset(offset);
      syncDecimalInput();
    });

    resetButton.addEventListener('click', () => {
      abacus.reset();
    });

    window.abacus = abacus;
    syncDecimalInput();
    updateTotals(abacus.getValue());
  </script>
</body>
</html>
